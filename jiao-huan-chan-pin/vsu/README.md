---
description: VSU原理与应用场景
---

# VSU配置

**应用场景：**

**使用VSU扩展端口数量**

如图所示。当接入的用户数增加到原交换机端口密度不能满足接入需求时，可以通过在原有的VSU系统中增加新的交换机而得到满足。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1adf0405_0.jpg)

**使用VSU扩展转发能力**

如图所示。当中心的交换机转发能力不能满足需求时，可以增加新交换机与原交换机组成VSU系统来实现。若一台交换机转发能力为128M PPS，则通过增加一台交换机进行扩展后，整个VSU设备的转发能力为256M PPS。需要强调的是，是整个VSU设备的转发能力整体提高，而不是单个交换机的转发能力提高。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1ae90407_0.jpg)

**使用VSU扩展带宽**

如图所示，当边缘交换机上行带宽增加时，可以增加新交换机与原交换机组成VSU系统来实现。将成员设备的多条物理链路配置成一个聚合组，可以增加到中心交换机的带宽。而对中心交换机的而言，边缘交换机的数量并没有变化，物理上的两台交换机看起来就是一台交换机，原有交换机会将当前的配置批量备份到新加入的交换机。因此，这种变化对网络规划和配置影响很小。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1af30409_0.jpg)

**使用VSU简化组网**

如下图是常见的网络组网，使用MSTP、VRRP等协议来支持链路冗余、网关备份。这种组网在各种场合均会使用，这里仅以汇聚层与接入层之间的组网为例。使用 VSU 后，汇聚层的多个设备成为了一个单一的逻辑设备，接入设备直接连接到虚拟设备。这个简化后的组网不再需要使用 MSTP、VRRP 协议，简化了网络配置。同时依靠跨设备的链路聚合，在成员出现故障时不再依赖 MSTP、VRRP 等协议的收敛，提高了可靠性。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1afd040b_0.jpg)

**网吧VSU万兆虚拟化环网方案**

如下图XX网吧进行网络升级，采购了我司一台RG-S5750-48GT/4SFP-S，两台RG-S5750-24GT/8SFP-S设备，组建VSU万兆虚拟化环网。全千兆接入到桌面PC，个别端口光纤下联HUB扩展千兆端口。双千兆上联出口路由器，同时网吧内部千兆服务器提供无盘启动，电影，游戏等服务。三台交换机组建成千兆接入，万兆互联的纯二层高速接入网络，全面提升链路带宽，客户上网体验，同时VSU带来的方便、集中式管理可减少维护量。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b100410_0.png)

**原理简介：**

VSU是一种将多台设备虚拟成一台设备来管理和使用的技术,能够显著减低管理复杂度，降低拓扑逻辑复杂度，和MSTP+VRRP网络相比，VSU通常和周边设备使用聚合口进行连接，能够有效利用冗余链路的同时提升系统的转发能力。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1ae90408_0.png)

**端口角色：**

VSU中每台设备都称为成员设备。成员设备按照功能不同，分为三种角色：

1）Active：主设备，负责管理整个VSU。

2）Standby：从设备，作为Active的备用设备运行。当Active故障时，Standby会自动升级为Active接替原Active工作。

3）Candidate：候选设备，作为Standby的备用设备运行。当Standby故障时，系统会自动从Candidate中选举一个新的Standby接替原Standby工作。另外，当Active故障时，在Standby自动升级为Active接替原Active工作的同时，系统也会自动从Candidate中选举一个新的Standby接替原Standby工作。

**域编号：**

域编号（Domain ID）是VSU的一个属性，是VSU的标识符，用来区分不同的VSU。两台交换机的domain ID相同，才能组成VSU。取值范围是1到255，缺省100。

**设备编号：**

设备编号Switch ID是成员设备的一个属性，是交换机在VSU中的成员编号，取值是1到8，缺省1。

在单机模式，接口编号采用二维格式（如GigabitEthernet 2/3）；而在VSU模式中，接口编号采用三维格式（如GigabitEthernet 1/2/3），第一维（数字1）表示机箱成员编号，后面两维（数字2和3）分别表示槽位号和该槽位上的接口编号。因此，在VSU中必须保证所有成员的设备编号都是唯一的。

如果建立VSU时成员设备的编号不唯一，系统会通过VSU自动编号机制为所有成员设备重新设定编号来保证编号的唯一性。

**设备优先级：**

优先级是成员设备的一个属性，在角色选举过程用到。优先级越高，被选举为主设备的可能性越大。取值范围是1到255，缺省优先级是100，如果想让某台设备被选举为主设备，应该提高该设备的优先级。

成员设备的优先级分为配置优先级和运行优先级。运行优先级等于启动时配置文件中保存的配置优先级，在VSU运行过程中不会变化，管理员修改了配置优先级，运行优先级还是原来的值，保存配置并重启后新配置的优先级才会生效。

**VSL**

虚拟交换链路（Virtual Switching Link，简称VSL）是VSU系统的设备间传输控制信息和数据流的特殊聚合链路。VSL端口以聚合端口组的形式存在，由VSL传输的数据流根据流量平衡算法在聚合端口的各个成员之间就进行负载均衡。

设备上可以用于VSL端口连接的物理端口称之为VSL成员端口。VSL成员端口可能是堆叠端口、以太网接口或者光口（设备上哪些端口可用作VSL成员端口与设备的型号有关，请以设备的实际情况为准）。

**VSU分裂：**

如下图所示，一个VSU形成后，由于VSL链路故障，导致VSU中两相邻成员设备物理上不连通，一个VSU变成两个VSU，这个过程称为VSU分裂。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1ae50406_0.jpg)

**VSU合并：**

如下图所示，两个各自稳定运行的VSU，如果它们的Domain ID相同，则可以通过在两个VSU之间增加VSL链接来使其合并成为一个VSU，这个过程称为VSU合并。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1aef0408_0.jpg)

**VSU工作模式：**

交换机有两种工作模式：单机模式和VSU模式，缺省工作模式是单机模式，要想组建VSU，必须把交换机的工作模式从单机模式切换到VSU模式。

对于支持使用堆叠口作为VSL成员端口的VSU系统而言，若系统在启机阶段识别到堆叠口，则自动激活到VSU模式，而不需要用户手工激活VSU模式。

**VSU连接介质：**

多台设备要组成VSU，需要先将成员设备的 VSL端口进行连接。设备支持的VSL端口的类型不同使用的连接介质不同。

1）如果使用堆叠口作为VSL端口，则需要使用堆叠专用线缆连接VSL端口。堆叠专用线缆能够为成员设备间报文的传输提供很高的可靠性和性能。（S26I）

2）如果使用以太网接口作为 VSL端口，则使用交叉网线连接VSL端口即可。这种连接方式提高了现有资源的利用率（以太网接口没有与VSL绑定时用于上下层设备间业务报文转发，与VSL绑定后专用于成员设备间报文转发，这种绑定关系可以通过命令行配置），有利于节约成本（不需要购置堆叠专用接口卡或者光模块等）。

3）如果使用光口作为 VSL端口，则使用光纤连接 VSL端口。这种连接方式可以将距离很远的物理设备连接组成VSU，使得应用更加灵活。

**VSU连接拓扑：**

线性拓扑

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b02040d_0.png)

环形拓扑

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b07040e_0.png)

环形拓扑比线形拓扑更可靠。因为当线形拓扑中出现VSL链路故障时，会引起VSU分裂；而环形拓扑中某个VSL链路出现故障时，只是导致环形拓扑变为线形拓扑，而VSU的业务不会受到影响。

**VSL检测：**

成员设备启机后，根据配置的VSL信息将物理端口识别为VSL口，并开始VSL检测。VSL检测主要是检测直连设备的VSL连接关系。当VSL状态变为UP之后，设备就可以开始拓扑发现。

**拓扑发现：**

VSU中的每台设备都是通过和拓扑中的其它成员设备之间交互VSU Hello报文来收集整个VSU的拓扑关系。VSU Hello报文会携带拓扑信息，包括本机的成员编号、设备优先级、MAC信息、VSU端口连接关系等内容。每个成员会在状态为UP的VSL口上向拓扑洪泛Hello报文，其他成员收到Hello报文后，会将报文从非入口的状态为UP的VSL口转发出去。

通过Hello报文的洪泛，每个成员设备可以逐一学到整个拓扑信息。当设备收集完拓扑信息后，开始进行角色选举。

**VSU角色选举：**

Active角色的选举规则如下：

当前主机优先。

设备优先级大的优先。

MAC地址小的优先。

Standby角色的选举规则如下：

最靠近主机的优先。

设备优先级大的优先。

MAC地址小的优先。

在角色选举阶段，所有的设备根据Active角色的选举规则从拓扑中推举出Active；被选为Active的设备从剩下设备中选出Standby。选举完成后，Active的设备向整个拓扑发送Convergence报文，通知拓扑中的所有设备一起进行拓扑收敛，然后VSU进入管理与维护阶段。

#### **双主机检测：**

当VSL断开导致Active设备和Standby设备分到不同的VSU时，就会产生VSU分裂。发生VSU分裂时，网络上会出现两个配置相同的VSU。在三层，两个VSU的任何一个虚接口（VLAN接口和环回接口等等）的配置相同，网络中出现IP地址冲突。

目前支持用BFD和聚合口检测双主机箱。如图6所示，需要在两台交换机之间建立一条双主机检测链路，当VSL断开时，两台交换机开始通过双主机检测链路发送检测报文，收到对端发来的双主机检测报文，就说明对端仍在正常运行，存在两台主机。

1）基于BFD检测：BFD的双主机检测端口必须是三层路由口，二层口、三层AP口或SVI口都不能作为BFD的检测端口；当用户将双主机检测端口从三层路由口转换为其他类型的端口模式时，BFD的双主机检测配置将自动清除，并给出提示。BFD检测采用扩展BFD，不能通过现有BFD的配置与显示命令配置双主机检测口。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b0c040f_0.png)

2）基于聚合口检测（图7）：基于聚合口检测双主机的机制与BFD类似。当VSL链路断开，产生双主机时，两个主机之间相互发送聚合口私有报文来检测多主机。与BFD检测的区别主要在于基于聚合口的检测需要配置在跨设备业务聚合端口上（不是VSL聚合端口），而且需要周边设备可以转发私有检测报文

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b110410_0.png)

**Recovery模式：**

检测出双主机以后，系统将根据双主机检测规则选出最优VSU和非最优VSU。最优VSU一方没有受到影响；非最优VSU一方进入恢复（recovery）模式，系统将会关闭除VSL端口和管理员指定的例外端口（管理员可以用config-vs-domain模式下的命令“dual-active exclude interface”指定哪些端口不被关闭）以外的所有物理端口。

在三机以上（包括三机）的VSU拓扑上，或者采用基于聚合口检测的VSU拓扑上，双主机检测规则参考“VSU合并”规则；对于基于BFD检测的双机VSU，则采用保留原主机的规则。这样做的目的是为了最大程度的保证双主机对业务的影响。

当VSU进入recovery模式后，提醒管理员：不要直接重启设备，最简单有效的处理方法是重新连接VSL。当排除VSL故障后，recovery模式的VSU会自动重启并加入到最优VSU的一方。

管理员不能在解决VSL故障之前就将设备直接复位，否则可能导致复位起来的设备没有加入到最优VSU一方，再次出现双主机冲突。

### **VSU报文转发原理**

VSU 采用分布式转发技术实现报文的二/三层转发，最大限度的发挥了每个成员的处理能力。VSU 系统中的每个成员设备都有完整的二/三层转发能力，当它收到待转发的二/三层报文时，可以通过查询本机的二/三层转发表得到报文的出接口（以及下一跳），然后将报文从正确的出接口送出去，这个出接口可以在本机上也可以在其它成员设备上，并且将报文从本机送到另外一个成员设备是一个纯粹内部的实现，对外界是完全屏蔽的，即对于三层报文来说，不管它在 VSU 系统内部穿过了多少成员设备，在跳数上只增加1，即表现为只经过了一个网络设备。

#### **本地转发**

如图所示，转发报文的入接口和出接口在同一台成员设备上。当成员设备收到报文后，查找本地转发表，发现出接口就在本机上，则成员设备直接将报文从这个出接口发送出去。 ![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1b160411_0.png)

#### **单播报文转发**

如图所示，转发报文的入接口和出接口在不同的成员设备上。当成员设备1 收到报文后，查找本地转发表，发现出接口在成员设备2上，则成员设备1根据单播最优路径将报文转发给成员设备2，而成员设备2最总将报文转发出去。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1ae60406_0.jpg)

#### **组播报文转发**

如图所示，成员设备1收到一个组播报文，它通过两个VSL通道将组播报文转发出去；在组播报文经过成员设备2和3时，由于成员设备2和3上均有组播接入，因此成员设备2和3会将报文转发出去；同时，根据组播转发原理，组播流量会分别截止于成员设备3和成员设备4，即成员设备3和成员设备4之间可自动避免报文环路。

![](https://image.ruijie.com.cn/Upload/Article/ed2b5aeb-92a6-48e3-b1d1-0c2ed8aeece3/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/%E9%94%90%E6%8D%B7%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%BA%A7%E5%93%81%E5%AE%9E%E6%96%BD%E4%B8%80%E6%9C%AC%E9%80%9AV5.0/599808fc-3cd1-4c84-9875-71869cfcd301_files/972b1065_1af00408_0.jpg)

